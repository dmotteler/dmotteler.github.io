<html><head><title>try save xml</title>
<script>
var songlib = [];
var songobj = [];
function init() {
    const xhr = new XMLHttpRequest();

    xhr.onload = function() {
        // alert("loaded!");
        let musiclib = xhr.responseXML.documentElement;
        for (let songNode of musiclib.children) {
            let song = [];
            let categories = [];
            for (let att of songNode.attributes) {
                song[att.name] = att.value;
            }

            let nam = song['name'];
            let sid = song['id'];

            for (let prop of songNode.children) {
                if (prop.nodeName == "alias") {
                    let aka = prop.textContent;
                    if (! songlib.hasOwnProperty(aka)) {
                        songlib[aka] = [];
                    }
                    songlib[aka].push(sid);
                } else if (prop.nodeName == "category") {
                    categories.push(prop.textContent);
                } else if (prop.nodeName == "tracks") {
                    let tracks = [];
                    for (let subp of prop.children) {
                        if (subp.nodeName == "voice") {
                            let voice = [];
                            let vname = 'phony';
                            for (let att of subp.attributes) {
                                if (att.name == 'voice') {
                                    vname = att.value;
                                } else {
                                    voice[att.name] = att.value;
                                }
                            }
                            tracks[vname] = Object.assign(voice);
                        }
                    }
                    song[prop.nodeName] = Object.assign(tracks);
                } else if (prop.nodeName == "sheet") {
                    let sheet = [];
                    for (let att of prop.attributes) {
                        sheet[att.name] = att.value;
                    }
                    song[prop.nodeName] = Object.assign(sheet);
                } else {
                    song[prop.nodeName] = prop.textContent;
                }
            }
            if (categories.length > 0) {
                song['categories'] = Object.assign(categories);
            }

            if (! songlib.hasOwnProperty(nam)) {
                songlib[nam] = [];
            }
            songlib[nam].push(sid);

            // clone the song object and add to list
            if (songobj.hasOwnProperty(sid)) {
                throw "found multiple songs with sid " + sid;
            }
            songobj[sid] = Object.assign(song);
        }
        sortedSongs = Object.keys(songlib).sort();
          let pltext = new XMLSerializer().serializeToString(musiclib);
        sendlib(pltext);
    }

    xhr.onerror = function() {
      console.log("Error while getting XML.");
    }

    xhr.open("GET", "musiclib.xml");
    // xhr.open("GET", "new.xml");
    xhr.responseType = "document";
    xhr.send();
}
function sendlib(lib) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("POST", "http://localhost/dfm_ws/musicxml/catcher.php", true);
    xmlhttp.onload = function () {
        console.log("lib saved.");
    }
    xmlhttp.send(lib);
}
    </script>
    </head>
<body onload="init()">
    <input type="hidden" id="xmlhere" value=""/>
</body>
</html>
