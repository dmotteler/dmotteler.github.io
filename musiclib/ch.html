<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title id="doctitle"></title>
<style>
.key, .pitch { text-align: center; }
td { padding: 6px; }
.tabletitle { background-color: lightgreen; text-align: center; font-size: 24px; border-bottom: solid 5px; }
.hidden { display: none; }
.qtet { background-color: blue !important; color: white !important; }
.qtet a { background-color: blue !important; color: white !important; }
tr:nth-child(even) { background: #CCC }
tr:nth-child(odd) { background: #FFF }
.partsel { text-align: center; background: lightgreen; }
table { border-collapse: collapse; font-family: Arial; font-size: 18px; font-weight: bold; border-width: 5px; }
@media print {
  @page { size: letter portrait; margin: .5in; }
  body { max-width: 5.5in; }
  table { font-size: 12px; }
  td { padding: 4px; }
  .tabletitle { font-size: 18px; }
}
</style>
<script>
var voices = ['bass', 'bari', 'lead', 'tenor', 'mix', 'none'];
function clickmix() {
    let defaultVoice = localStorage.getItem("defaultVoice");
    if (! defaultVoice) { defaultVoice = "mix"; }
    let buttonId = "sel" + defaultVoice;
    let butt = document.getElementById(buttonId);
    butt.click();
}
function setvoice(el) {
    let voice = el.value;
    // show the class we were called with (i.e., remove "hidden")
    for (let element of document.getElementsByClassName(voice)) {
       element.classList.remove("hidden");
    }
    let others = new Set(voices);
    others.delete(voice);
    // don't show the rest of the classes
    for (let v of others) {
        for (let element of document.getElementsByClassName(v)) { element.classList.add("hidden"); }
    }
    if (voice != "none") {
        localStorage.setItem("defaultVoice", voice);
    }
}
// BEGIN CLIP
// songlib is indexed by song name, values are
//   lists of song ids with that name
var songlib = [];
// songobj is indexed by song id, values are
//   details for the song
var songobj = [];
var evdate;
var evndx;
var venue;
var title;
var songlist;
var qtetSongs;

function init() {
    const xhr = new XMLHttpRequest();

    xhr.onload = function() {
        // alert("loaded!");
        let musiclib = xhr.responseXML.documentElement;
        // console.log(musiclib.nodeName);
        for (let songNode of musiclib.children) {
            let song = [];
            let categories = [];
            for (let att of songNode.attributes) {
                song[att.name] = att.value;
            }

            let nam = song['name'];
            let sid = song['id'];

            for (let prop of songNode.children) {
                if (prop.nodeName == "alias") {
                    let aka = prop.textContent;
                    if (! songlib.hasOwnProperty(aka)) {
                        songlib[aka] = [];
                    }
                    songlib[aka].push(sid);
                } else if (prop.nodeName == "category") {
                    categories.push(prop.textContent);
                } else if (prop.nodeName == "tracks") {
                    let tracks = [];
                    for (let subp of prop.children) {
                        if (subp.nodeName == "voice") {
                            let voice = [];
                            let vname = 'phony';
                            for (let att of subp.attributes) {
                                if (att.name == 'voice') {
                                    vname = att.value;
                                } else {
                                    voice[att.name] = att.value;
                                }
                            }
                            if (!tracks.hasOwnProperty(vname)) {
                                tracks[vname] = [];
                            }
                            tracks[vname].push(Object.assign(voice));
                        }
                    }
                    song[prop.nodeName] = Object.assign(tracks);
                } else if (prop.nodeName == "sheet") {
                    let sheet = [];
                    for (let att of prop.attributes) {
                        sheet[att.name] = att.value;
                    }
                    song[prop.nodeName] = Object.assign(sheet);
                } else {
                    song[prop.nodeName] = prop.textContent;
                }
            }
            if (categories.length > 0) {
                song['categories'] = Object.assign(categories);
                if (categories.includes("Old")) {
                    nam += " (Old)";
                }
            }

            if (! songlib.hasOwnProperty(nam)) {
                songlib[nam] = [];
            }
            songlib[nam].push(sid);

            // clone the song object and add to list
            if (songobj.hasOwnProperty(sid)) {
                throw "found multiple songs with sid " + sid;
            }
            songobj[sid] = Object.assign(song);
        }
        // load and parse the event list
        let eljson = localStorage.getItem('TunersEvents');

        if (eljson) {
            var eventlist = JSON.parse(eljson);
        } else {
            alert("couldn't load the event list from local storage.");
            return;
        }

        // showEvent is the index of the last event selected by picksongs. 
        let evjson = localStorage.getItem('showEvent');

        if (evjson) {
            evndx = JSON.parse(evjson);
        } else {
            throw "couldn't find current event in local storage.";
        }

        let ev = eventlist[evndx];
        venue = ev['where'];
        evdate = ev['when'];
        title = `${venue} - ${evdate}`;
        document.title = title;
        document.getElementById("evtitl").innerText = title;
        songlist = ev['songlist'];
        qtetSongs = [];
        if (ev.hasOwnProperty("qtetSongs")) {
            qtetSongs = ev['qtetSongs'];
        }
        makelist();
        clickmix();
    }

    xhr.onerror = function() {
      console.log("Error while getting XML.");
    }

    xhr.open("GET", "musiclib.xml");
    xhr.responseType = "document";
    xhr.send();
}
function makelist() {
    let html = "";
    for (let nam of songlist) {
        let songTitle = nam; // songTitle is nam (notes) [location]
        for (let sid of songlib[nam]) {
            let key = songobj[sid]['key'];
            let keyclass = "key";
            if (songobj[sid].hasOwnProperty('pitch')) {
                let pit = songobj[sid]['pitch'];
                if (pit != "") {
                    key = 'blow ' + pit;
                    keyclass = "pitch";
                }
            }
            let words = songobj[sid]['words'];
            if (songobj[sid].hasOwnProperty("notes")) {
                songTitle += ` (${songobj[sid]['notes']})`;
            }
            if (songobj[sid].hasOwnProperty("location")) {
                songTitle += ` [${songobj[sid]['location']}]`;
            }
            let picks = "";
            if (songobj[sid].hasOwnProperty("tracks")) {
                for (let voice of voices) {
                    let choices = [];
                    let ancclass = voice;
                    if (voice != "mix") {
                        ancclass += " hidden";
                    }
                    if (songobj[sid]['tracks'].hasOwnProperty(voice)) {
                        for (let vtrk of songobj[sid]['tracks'][voice]) {
                            let gdid = vtrk['gdid'];
                            let mods = vtrk['mods'];
                            choices.push(`<a href='https://drive.google.com/open?id=${gdid}'>${songTitle} : ${mods}</a>`);
                        }
                    } else if (voice == "none") {
                        // don't include location for voice none
                        let short = nam;
                        if (songobj[sid].hasOwnProperty("notes")) {
                            short += ` (${songobj[sid]['notes']})`;
                        }
                        choices.push(short);
                    } else { 
                        // no tracks for this voice
                        choices.push(songTitle);
                    }
                    picks += `<div class='${ancclass}'>` + choices.join("<br/>\n") + "\n</div>";
                }
            } else {
                picks = songTitle + "\n";
            }

            if (qtetSongs.includes(nam)) {
                html += `<tr class='qtet'><td class='${keyclass}'>${key}</td><td>${picks}</td><td>${words}</td></tr>\n`;
            } else {
                html += `<tr><td class='${keyclass}'>${key}</td><td>${picks}</td><td>${words}</td></tr>\n`;
            }

        }
    }
    document.getElementById("putithere").outerHTML=html;
}
function editlist() {
    window.location.href = "el.html";
}
function down() {
    // hide the buttons in the downloaded file
    document.getElementById("butts").classList.add("hidden");

    // get the html
    let h = document.documentElement.outerHTML;

    // remove the functions not needed in downloaded file
    let clipstart = h.indexOf("// BEGIN CLIP");
    let clipend = h.lastIndexOf("// END CLIP") + "// END CLIP".length + 1;
    let dlhtml = h.substr(0, clipstart) + h.substr(clipend).replace("init", "clickmix");

    let moda = evndx.substring(4, 8);
    let dlfn = `${venue}_${moda}.html`;
    let pom = document.createElement('a');
    pom.style.display = 'none';
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(dlhtml));
    pom.setAttribute('download', dlfn);
    document.body.appendChild(pom);
    pom.click();
    document.body.removeChild(pom);
}
// END CLIP
</script>
</head>
<body onload='init()'>
<table border='1'>
    <tr><td id='evtitl' colspan='3' class='tabletitle'></td></tr>
    <tr id="putithere"></tr>
<tr>
<td id='butts' class='partsel'><input type="button" value="Download" onclick="down()"></input><br/>
<input type="button" value="Edit list" onclick="editlist()"></input></td>
<td colspan='3' class='partsel'>
<fieldset class='partsel'>
<legend>Show voice</legend>
 <input type="radio" id="seltenor" name="part" value="tenor" onclick="setvoice(this)">tenor</input>
 <input type="radio" id="sellead" name="part" value="lead" onclick="setvoice(this)">lead</input>
 <input type="radio" id="selbari" name="part" value="bari" onclick="setvoice(this)">bari</input>
 <input type="radio" id="selbass" name="part" value="bass" onclick="setvoice(this)">bass</input>
 <input type="radio" id="selmix" name="part" value="mix" onclick="setvoice(this)">mix</input>
 <input type="radio" id="selnone" name="part" value="none" onclick="setvoice(this)">none</input>
</fieldset>
 </td></tr>
</table>
</body>
</html>
