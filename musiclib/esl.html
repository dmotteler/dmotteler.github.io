<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--

    $Id: esl.html,v 1.1 2022/02/01 04:54:42 dfm Exp dfm $
    $Log: esl.html,v $
    Revision 1.1  2022/02/01 04:54:42  dfm
    Initial revision


    web page to edit the Tuners music library (xml)
-->
<title id="doctitle">Tuners Song Library</title>
<style>
.isClone { background-color: lightyellow; }
td,th { border-style: solid; border-color: black; border-width: 2px; padding: 6px; font-family: Arial; font-size: 18px; }
th { background-color: lightgreen; border-bottom: solid 2px; }
tr:nth-child(even) { background: #CCC }
tr:nth-child(odd) { background: #FFF }
table { border-style: solid; border-collapse: collapse; border-width: 2px; border-color: black; }
@media print {
  @page { size: letter portrait; margin: .25in; }
  html, body { width: 8.0in; height: 90%; }
}
</style>
<script src="fmtDate.js"></script>
<script>
// define globals here...
var deleteCount = 0;

var songobjects = []; // array of song objects
var tableHeaders = []; // column names of displayed table

var sidcol; // column number for song id
var sortcol = 'name'; // column name to sort by

function bycol(a, b) {
    // a and b songobjects, want to sort
    // according to column name in global 'sortcol'.
    let rv = 0;
    if (a.hasOwnProperty(sortcol)) {
        if (b.hasOwnProperty(sortcol)) {
            if (a[sortcol].toString() < b[sortcol].toString()) {
                rv = -1;
            } else if (a[sortcol] > b[sortcol]) {
                rv = 1;
            }
        } else {
            rv = -1;
        }
    } else {
        if (b.hasOwnProperty(sortcol)) {
            rv = 1;
        }
    }
    // console.log(`${sortcol} ${a[sortcol].toString()} : ${b[sortcol].toString()} -> ${rv}`);
    return rv;
}
// from https://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-deep-clone-an-object-in-javascript
function copy(o) {
  let out, v, key;
  out = Array.isArray(o) ? [] : {};
  for (key in o) {
    v = o[key];
    out[key] = (typeof v === "object" && v !== null) ? copy(v) : v;
  }
  return out;
}
function displaySongs() {
    let detbutt = document.querySelector("#showdetail");
    let detail = detbutt.checked;
    // console.log(`in displaySongs, detail checked is ${detail}`);

    // columns in brief listing...
    let briefHeaders = ['name', 'category', 'id', 'key', 'words'];

    // columns in detailed listing...
    let detailHeaders = ['name', 'category', 'id', 'notes', 'location', 'key', 'pitch', 'words',
        'arranger', 'composer', 'lyricist', 'learn_by', 'ordered', 'stockID', 'copies', 'source',
        'copyright', 'crdate'];

    if (detail) {
        tableHeaders = detailHeaders;
    } else {
        tableHeaders = briefHeaders;
    }
    sidcol = tableHeaders.indexOf('id');

    let songtable = "<thead><tr onclick='tabsort()'>";
    songtable += "<th>" + tableHeaders.join("</th><th>") + "</th></tr>\n";
    songtable += "<tbody>\n";

    for (let song of songobjects.sort(bycol)) {
        let rowhtml = "<tr>";
        for (let colnam of tableHeaders) {
            let val = "";
            if (colnam == "category") {
                val = song['categories'].join(", ");
            } else if (song.hasOwnProperty(colnam)) {
                val = song[colnam];
            } else {
                val = "&nbsp;";
            }
            if (song.isClone && colnam == "id") {
                rowhtml += `<td class='isClone'>${val}</td>`;
            } else {
                rowhtml += `<td>${val}</td>`;
            }
        }
        rowhtml += "</tr>\n";

        songtable += rowhtml;
    }
    let st = document.querySelector("#songtable");
    st.innerHTML = songtable;
}
function loadDoc(doc) {
  let xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        docReady(this);
    }
  };
  xhr.open("GET", doc, true);
  xhr.send();
}
function docReady(xhr) {
    // called when lib xml is ready to process. load info into
    // songobjects. Then call displaySongs to create the initial
    // table for display.

    let musiclib = xhr.responseXML.documentElement;

    for (let songNode of musiclib.children) {
        let song = [];
        for (let att of songNode.attributes) {
            song[att.name] = att.value;
        }

        let akas = [];
        let cat = '';
        let categories = [];

        for (let prop of songNode.children) {
            if (prop.nodeName == "alias") {
                akas.push(prop.textContent);
            } else if (prop.nodeName == "category") {
                cat = prop.textContent;
                categories.push(cat);
            } else if (prop.nodeName == "tracks") {
                let tracks = [];
                for (let subp of prop.children) {
                    if (subp.nodeName == "voice") {
                        let voice = [];
                        let vname = 'phony';
                        for (let att of subp.attributes) {
                            if (att.name == 'voice') {
                                vname = att.value;
                            } else {
                                voice[att.name] = att.value;
                            }
                        }
                        tracks[vname] = Object.assign(voice);
                    } else {
                        alert("unexpected tracks subnode " + subp.nodeName);
                    }
                }
                song[prop.nodeName] = Object.assign(tracks);
            } else if (prop.nodeName == "sheet") {
                let sheet = [];
                for (let att of prop.attributes) {
                    sheet[att.name] = att.value;
                }
                song[prop.nodeName] = Object.assign(sheet);
            } else {
                song[prop.nodeName] = prop.textContent;
            }
        }
        if (akas.length > 0) {
            song['aliases'] = Object.assign(akas);
        }
        if (categories.length > 0) {
            song['categories'] = Object.assign(categories);
        }

        // add the song object to list
        songobjects.push(song);

        // add a copy of the song for each alias
        akas.forEach(function(alias) {
            let clone = copy(song);
            clone.name = alias;
            clone.isClone = true;
            songobjects.push(clone);
        });
    }

    displaySongs();
}
function tabsort() {
    // user clicked on a song table header - sort the table
    // event target better be a cell (th).
    // target.parentNode is row (tr).
    // get column from td, row from tr.

    let th = event.target;
    if (th.tagName != "TH") {
        alert(`bad selection for tabsort! tag is ${th.tagName}`);
        window.getSelection().empty();
        return;
    }

    let tr = th.parentNode;
    sortcol = th.innerText;
    if (sortcol == "category") {
        sortcol = "categories";
    }
    console.log("sort on " + sortcol);
    displaySongs();
}
function selsong() {
    let tgt = event.target;
    let tr = tgt.closest("tr");
    let sid = tr.children[sidcol].innerText;
    window.location.href = `editsong.html?sid=${sid}`;
}
</script>
</head>
<body onload="loadDoc('musiclib.xml')">
<input type='checkbox' id='showdetail' value='Detail' onChange='displaySongs()'/>
<label for='showdetail'>Detail</label>
<input type='button' value='Add Song' onClick='addsong()'/>
<table id='songtable' ondblclick='selsong()'>
<tbody>
</table>
</body></html>
