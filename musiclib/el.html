<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title class="doctitle">${title}</title>
<style>
#wrapper { width: 500px; }
#playlist { width: 100%;  }
.footer { text-align: center; background: lightgreen; }
table { border-collapse: collapse; font-family: Arial; font-size: 18px; font-weight: bold; border-width: 5px; }
table, p, option, select { border-collapse: collapse; font-family: Arial; font-size: 18px; font-weight: bold; border-width: 5px; }
td,th { border-style: solid; border-color: black; border-width: 2px; }
.key { text-align: center; }
td { padding: 6px; }
img { width: 50%; height: 50%; vertical-align: middle;
    display: block; margin-left: auto; margin-right: auto; }
caption { background-color: lightgreen; text-align: center;
    font-size: 24px; border-bottom: solid 5px; padding: 5px; }
.selimg { width: 40px; }
.hidden { display: none; }
.qtet { background-color: blue; color: white; }
.song:not(.slctd):not(.qtet):nth-child(even) { background-color: silver; }
.song:not(.slctd):not(.qtet):nth-child(odd) { background-color: white; }
span.u { text-decoration: underline black; font-style: italic; }
@media print {
  @page { size: letter portrait; margin: .5in; }
  table { font-size: 12px; }
  td { padding: 4px; }
}
</style>
<script>
function sledit(el) {
    // this function is called when the action menu item 
    // is clicked. it displays the correspoding action message,
    // and the action is performed when that message is responded to.
    // 
    // el is the pick from the function table
    let func = el.value;

    // turn the button off.
    el.checked = false;

    let songrow = document.querySelector(".slctd");
    if (! songrow) {
        document.getElementById("editmenu").innerHTML = "<p>Select a song first!</p>";
        return;
    }
    let cursong = songrow.children[0].innerText;
    let songndx = songrow.rowIndex;
    if (songndx < 0) {
        throw `${cursong} not found in ${songlist}`;
    }

    // build select for current songlist. default option 0
    // is hidden because it con't be selected.

    let editmenu = "";
    switch (func) {
        case "mov":
            let slsel = "<select id='slel'>";
            slsel += `<option style="display:none">
        <option>--top--</option>
        `
            for (let s of songlist) {
                slsel += `<option>${s}</option>\n`;
            }
            slsel += "</select>\n";
            editmenu = `<p onchange="slfunc('mov', this, ${songndx})">move <span class="u">${cursong}</span> after ${slsel}</p>`;
            break;
        case "del":
            editmenu = `<p onclick="slfunc('del', this,  ${songndx})">click here to remove <span class="u">${cursong}</span></p>`;
            break;
        case "rep":
            editmenu = `<p onchange="slfunc('rep', this, ${songndx})">replace <span class="u">${cursong}</span> with ${libsel}</p>`;
            break;
        case "add":
            editmenu = `<p onchange="slfunc('add', this, ${songndx})">add ${libsel} after <span class="u">${cursong}</span></p>`;
            break;
        default:
            alert("wtf is " + func);
            exit();
    }
    document.getElementById("editmenu").innerHTML = editmenu;
    console.log(`editmenu: ${editmenu}`);
}

function slfunc(func, el, ndx) {
    let cursong = songlist[ndx];
    console.log(`slfunc: ${func}, ${ndx}, ${cursong}`);
    switch (func) {
        case "mov":
            // get the position in the songlist select, and the song name.
            // the -2 adjusts for the hidden option at 0 and --top-- at 1,
            // which aren't in songlist.
            let aftndx = el.children[1].selectedIndex - 2;
            let aftsong = songlist[aftndx];
            if (aftndx == -1) {
                aftsong = "--top--";
            }
            if (aftndx > ndx) {
                // when we're moving "down", adjust aftndx to reflect
                // that we remove the song first.
                aftndx -= 1;
            }
            // splice returns a list of removed songs - get the first (only) one.
            let moved = songlist.splice(ndx, 1)[0];
            if (moved != cursong) {
                throw `wanted ${cursong}, but splice gave ${moved}??`;
            }
            songlist.splice(aftndx + 1, 0, moved);
            console.log(`moved ${cursong} after ${aftsong} - ${songlist}`);
            break;
        case "del":
            let r = songlist.splice(ndx, 1);
            console.log(`removed ${r} - ${songlist}`);
            break;
        case "rep":
            let newsong = el.children[1].value;
            songlist.splice(ndx, 1, newsong);
            console.log(`replaced ${cursong} with ${newsong} - ${songlist}`);
            break;
        case "add":
            let addndx = el.children[0].selectedIndex;
            let addsong = el.children[0][addndx].value;
            songlist.splice(ndx+1, 0, addsong);
            console.log(`added ${addsong} after ${cursong} - ${songlist}`);
            break;
        case "qtet":
            break;
        default:
            throw `what kind of function is ${func}`;
    }
    let songrow = document.querySelector(".slctd");
    songrow.querySelector("img").src = checksvg;
    songrow.classList.remove("slctd")
    document.getElementById("editmenu").innerHTML = "<p><strong>Select a song, then choose an action.</strong></p>";

    makelist();
}
function makelist() {
    let html = "";
    for (let song of songlist) {
        let cl = qtetSongs.includes(song) ? "class='qtet song'" : "class='song'"
        html += `<tr onclick="selsong(this)" ${cl}><td>${song}</td><td class="selimg"><img src=""/></td></tr>`;
    }
    document.getElementById("playlist").innerHTML = html;
    let chkimgs = document.querySelectorAll("img");
    for (let img of chkimgs) {
        img.src = nochecksvg;
    }
}
var datndx;
var evdate;
var eventlist = [];
var libsel;
var qtetSongs = [];
var songlist = [];
var title;
var venue;
var checksvg; // svg for check mark to indicate selected row
var nochecksvg; // svg to replace check for non-selected row

function init() {
    checksvg = `data:image/svg+xml;utf8,
%3Csvg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="128" height="128"%3E
  %3Crect width="128" height="128" fill="none" /%3E
  %3Ccircle cx="64" cy="64" r="59" fill="yellow" stroke="black" stroke-width="10"/%3E
  %3Cpolyline points="32,64 53,83 95,42" fill="none" stroke="black" stroke-width="10" stroke-linecap="round" /%3E
%3C/svg%3E`;

    nochecksvg = `data:image/svg+xml;utf8,
%3Csvg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="128" height="128"%3E
  %3Crect width="128" height="128" fill="none" /%3E
%3C/svg%3E`;

    // load and parse the song name list (actually a <select>)
    let lsjson = localStorage.getItem('songlibsel');

    if (lsjson) {
        libsel = JSON.parse(lsjson);
    } else {
        alert("couldn't load the lib song list from local storage.");
        return;
    }

    // load and parse the event list
    let eljson = localStorage.getItem('TunersEvents');

    if (eljson) {
        eventlist = JSON.parse(eljson);
    } else {
        alert("couldn't load the event list from local storage.");
        return;
    }

    // showEvent is the index of the last event selected by picksongs. 
    let evjson = localStorage.getItem('showEvent');

    if (evjson) {
        datndx = JSON.parse(evjson);
    } else {
        alert("couldn't find current event in local storage.");
        return;
    }

    let ev = eventlist[datndx];

    venue = ev['where'];
    evdate = ev['when'];

    title = `${venue} - ${evdate}`;
    document.title = title;
    document.querySelector("#playlist").caption.textContent = title;

    songlist = ev['songlist'];

    qtetSongs = [];
    if (ev.hasOwnProperty("qtetSongs")) {
        qtetSongs = ev['qtetSongs'];
    }
    makelist();
}
function selsong(el) {
    // el is the row where the left-click was done, or
    // the table where a right-click was done.
    let cursong = "";
    if (el.id == "playlist") {
        // right-click will do the context menu when we leave
        // if we don't prevent it.
        event.preventDefault();
        let td = event.target;
        cursong = td.innerText;

        // get the row element from the parent of the
        // td where the right-click was done.
        el = td.parentNode;

        // toggle qtet class for the song
        if (el.classList.contains("qtet")) {
            el.classList.remove("qtet");
            let index = qtetSongs.indexOf(cursong);
            if (index > -1) {
                qtetSongs.splice(index, 1);
            }
            console.log(`${cursong} not a quartet song.`);
        } else {
            el.classList.add("qtet");
            qtetSongs.push(cursong);
            console.log(`${cursong} is now a quartet song.`);
        }
        return;
    }
    // get song name from td element
    cursong = el.children[0].innerText;
    let cursels = document.querySelectorAll(".slctd");
    for (let s of cursels) {
        s.classList.remove("slctd");
        s.querySelector("img").src = nochecksvg;
    }
    if (cursels.length > 0) {
        if (cursels[0] == el) {
            // same song re-selected - reset the edit menu instruction and leave
            document.getElementById("editmenu").innerHTML = "<p><strong>Select a song, then choose an action.</strong></p>";
            return;
        }
    }

    el.classList.add("slctd");
    el.querySelector("img").src = checksvg;
    document.getElementById("editmenu").innerHTML = `<p>Choose an action for <span class="u">${cursong}</span></p>`;
}
function done() {
    // go back to caller after updating songlist in local storage.
    let newevent = {'when': evdate, 'where': venue, 'songlist': songlist, 'qtetSongs': qtetSongs };
    eventlist[datndx] = newevent;
    console.log(`leaving with newevent ${newevent}`);

    // replace the updated event list in local storage.
    localStorage.setItem('TunersEvents', JSON.stringify(eventlist));

    window.location.href = "ch.html";
}
function cancel() {
    console.log(`leavging without updating eventlist (cancel)`);
    window.location.href = "ch.html";
}
</script>
</head>
<body onload="init()">
<table id="wrapper" border="1">
<tr><td>
  <table id='playlist' oncontextmenu="selsong(this)">
    <caption>${title}</caption>
    <tr id="putithere"></tr>
  </table>
</td></tr>
<tr><td>
  <div id='editmenu'> <p><strong>Select a song, then choose an action.</strong></p> </div>
</td></tr>
<tr><td>
 <table><tr class="footer">
  <td><input type="button" value="Done" onclick="done()"><br>
   <input type="button" value="Cancel" onclick="cancel()"></td>
  <td width="100%">
    <fieldset>
     <legend>Choose action</legend>
     <input type="radio" name="act" value="mov" onclick="sledit(this)">move
     <input type="radio" name="act" value="del" onclick="sledit(this)">remove
     <input type="radio" name="act" value="rep" onclick="sledit(this)">replace
     <input type="radio" name="act" value="add" onclick="sledit(this)">add
    </fieldset>
  </table>
</td></tr>
</table>
</body>
</html>
