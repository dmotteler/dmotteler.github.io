<html><head><title>user song selection</title>
<script>
var sids = [];
function songsel(el) {
    let sid = el.value;
    let nam = opener.musiclib[sid].name;
    let sel = el.checked;
    if (sel) {
        let n = sids.indexOf(sid);
        if (n == -1) {
            sids.push(sid);
        }
    } else {
        let n = sids.indexOf(sid);
        if (n > -1) {
            sids.splice(n, 1);
        }
    }
    console.log(`${sid} ${nam} ${sids}`);
}
function init() {
    // present list of songs for selection, to add one or
    // more to the cheat sheet.

    sids = [...opener.selectedSids];

    // build list of song names in order
    // filter based on currently selected categories.
    let catboxes = opener.document.querySelectorAll("input[name='cats']");
    let curcatels = Array.from(catboxes).filter( cat => cat.checked );
    let curcats = curcatels.map( el => el.value );

    let ml = opener.musiclib;
    let sl = opener.songlib;

    function hascat(nam) {
        let rv = false;
        for (let sid of sl[nam]) {
            if (ml[sid].hasOwnProperty('aliasfor')) {
                sid = ml[sid]['aliasfor'];
            }
            for (let cat of ml[sid]['category']) {
                if (curcats.includes(cat)) {
                    rv = true;
                    break;
                }
            }
        }
        return rv;
    }

    // build the list of songs in the selected categories
    let songs = Object.keys(sl).filter( nam => hascat(nam) );
    const fldset = document.querySelector("fieldset");

    for (let nam of songs.sort()) {
        const label = document.createElement('label');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        let sid = opener.songlib[nam][0];
        checkbox.value = sid;
        checkbox.checked = sids.indexOf(sid) >= 0;
        checkbox.addEventListener("click", ev => songsel(ev.target));

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + nam)); // Add a space for readability

        const br = document.createElement("br");
        label.appendChild(br);

        // Append the label (containing the checkbox) to the fieldset
        fldset.appendChild(label);
    }
}
function ret() {
    console.log(`leaving with ${sids}`);
    let ssel = window.opener.document.querySelector("#ssel");
    ssel.innerText = sids.join(",");
    window.close();
}
</script>
</head>
<body onload="init()">
<button onclick="ret()">Done</button>
<fieldset id="songs">
 <legend>Select song(s)</legend>
</fieldset>
</body>
</html>
