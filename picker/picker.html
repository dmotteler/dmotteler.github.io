<!DOCTYPE html>
<!-- $Id: picker.html,v 1.6 2022/09/12 19:10:20 dfm Exp dfm $
     Log:$

     provide song list for cheat-sheet song selection

     uses the drag-drop editing, has help, does download.
     i.e., replaces ps, ch and el

-->
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Pick songs</title>
<link rel="stylesheet" href="/musiclib/select.css" />
<link rel="stylesheet" href="/musiclib/xmlpick.css" />
<link rel="stylesheet" href="picker.css" />
<style>
body { width: 1000px; }
table { width: 90%; }
alert.big { font-size: 24px; }
.svi { width: 42px; }
.warn { background-color: pink; }
input::placeholder { font-weight: bold; opacity: 0.5; color: green; }
.blink { animation: blink 3s linear infinite; }
@keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
</style>
<script src="/formatDate.js"></script>
<script src="/musiclib/getMusicLib.js"></script>
<script src="/musiclib/getEventList.js"></script>
<script type="text/javascript">

var aliasfor = []; // gives main sid for an alias sid
var allcats = []; // all categories from musiclib
var evcats = []; // all categories for songs in current event
var psCatSelected = []; // indexed by cat, true if cat checked. passed to ch and el
var eventlist = {}; // indexed by ymdhm of event, value is event definition
var evndx = ""; // event date, used to index eventlist. passed to ch.html
var evdate = ""; // event date, formatted for title
var fulldate = ""; // event date, formatted for the reader.
var musiclib = {}; // indexed by song id, value is song element.
var nevshow = 999; // number of events from eventlist to show in "Use"
var newevent; // event passed to ch.html
var songlib = []; // indexed by song name, value list of sids
var songlist = []; // all song sids for an event
var qtetSongs = []; // quartet song sids for an event
var venue = ""; // venue for event

var selectedSids = [];
function adds() {
    // present list of songs for selection, to add one or
    // more to the cheat sheet.
    let songwin = window.open("selsongs.html");
    console.log(selectedSids);
    songwin.onblur = function() {
        if (songwin.closed) {
            console.log(`back from selsongs.html with sids ${selectedSids}`);
            if (selectedSids.length > 0) {
                for (let sid of selectedSids) {
                    if (! songlist.includes(sid)) {
                        songlist.push(sid);
                    }
                }
                makelist();
            } else {
                console.log(`no songs added.`);
            }
        } else {
            console.log("songwin unload in parent?");
        }
    }
}
function dodl() {
    // download requested - create the cheat sheet and download it.

    if (!venue || !evndx || songlist.length < 1) {
        console.log("download request ignored - no event defined.");
        return;
    }

    let title = `${venue} - ${evdate}`;
    document.title = title;

    let cheat = `<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title id="doctitle">${title}</title>
<style>
table { border: 5px solid black; border-spacing: 0px;
    font-family: Arial; font-size: 18px; font-weight: bold; }
td { border: 1px solid black; padding: 6px; }
tr:nth-child(even) { background: #CCC }
tr:nth-child(odd) { background: #FFF }
.tabletitle { background-color: lightgreen; text-align: center; font-size: 24px; border-bottom: solid 5px; }
.key, .pitch { text-align: center; }
.hidden { display: none; }
.qtet { background-color: blue !important; color: white !important; }
.qtet a { background-color: blue !important; color: white !important; }
.partsel { text-align: center; background: lightgreen; }
@media print {
  @page { size: letter portrait; margin: .5in; }
  body { max-width: 5.5in; }
  table { font-size: 12px; }
  td { padding: 4px; }
  .tabletitle { font-size: 18px; }
}
</style>

<scr
ipt>
var voices = ['bass', 'bari', 'lead', 'tenor', 'mix', 'none', 'sheet'];
var showVoice;
function clickVoice() {
    // set showVoice, then emulate clicking that voice selection
    // to get the tracks showing or hidden. this is the init function
    // when a downloaded cheat is executed.

    showVoice = localStorage.getItem("defaultVoice");
    if (! showVoice) { showVoice = "mix"; }
    let buttonId = "#sel" + showVoice;
    let butt = document.querySelector(buttonId);
    butt.click();
}
function setvoice(el) {
    let voice = el.value;
    let clr = "." + voice;
    // show the class we were called with (i.e., remove "hidden")
    document.querySelectorAll(clr).forEach(node => { node.classList.remove("hidden") });

    let others = new Set(voices);
    others.delete(voice);
    // don't show the rest of the classes
    for (let v of others) {
        let cla = "." + v;
        document.querySelectorAll(cla).forEach(node => { node.classList.add("hidden") });
    }
    if (voice != "none" && voice != "sheet") {
        localStorage.setItem("defaultVoice", voice);
    }
}
</scr
ipt>

</head>
<body onload="clickVoice()">
    <table>
`;
    // create the html for the songlist display. 
    // each row has key, song title, starting words
    // for all songs from the songlist.
    // the song title td has a div for each voice, with class "hidden" 
    // for all except the current voice being displayed.

    showVoice = localStorage.getItem("defaultVoice");
    if (! showVoice) { showVoice = "mix"; }

    cheat += `<tbody id='main_table'><tr><td colspan='3' class='tabletitle'>${title}</td></tr>`;
    console.log(`in makelist, songlist ${songlist}`);
    for (let sid of songlist) {
        let song = musiclib[sid];
        let songTitle = song['name']; // songTitle becomes name (notes) [location]
        if (song.hasOwnProperty("aliasfor")) {
            let msid = song["aliasfor"];
            song = musiclib[msid];
        }
        let key = song['key'];
        let keyclass = "key";
        if (song.hasOwnProperty('pitch')) {
            let pit = song['pitch'];
            if (pit != "") {
                key = 'blow ' + pit;
                keyclass = "pitch";
            }
        }
        let words = song['words'];
        if (song.hasOwnProperty("notes")) {
            songTitle += ` (${song['notes']})`;
        }
        if (song.hasOwnProperty("location")) {
            songTitle += ` [${song['location']}]`;
        }
        let picks = "";
        // if we have any tracks for this song, add a div
        // for each track to the song title td, with class "hidden"
        // for all but the active voice
        let  voices = ['bass', 'bari', 'lead', 'tenor', 'mix', 'none', 'sheet'];
        for (let voice of voices) {
            let ancclass = voice == showVoice ? voice : voice + " hidden";

            if (voice == "none") {
                picks += `<div class='${ancclass}'>${songTitle}</div>\n`;

            } else if (voice == "sheet") {
                if (song.hasOwnProperty("sheet")) {
                    // song has a sheet - all sheets have gdid, may have res. key
                    let anc;
                    let gdid = song['sheet']['gdid'];
                    if (song['sheet'].hasOwnProperty('resource_key')) {
                        let rk = song['sheet']['resource_key'];
                        anc = `<a href='https://drive.google.com/open?id=${gdid}&resourcekey=${rk}'>${songTitle} [sheet]</a>`;
                    } else {
                        anc = `<a href='https://drive.google.com/open?id=${gdid}'>${songTitle} [sheet]</a>`;
                    }
                    picks += `<div class='${ancclass}'>${anc}</div>\n`;
                } else {
                    // no sheet for this song - sheet entry is just song title
                    picks += `<div class='${ancclass}'>${songTitle}</div>\n`;
                }
            } else {
                // voice is one that may have tracks

                // choices is a list of tracks for this voice (part or mix)
                let choices = [];

                if (song.hasOwnProperty("tracks")) {
                    let v;
                    if (song['tracks'].hasOwnProperty(voice)) {
                        v = voice;
                    } else if (song['tracks'].hasOwnProperty('mix')) {
                        v = 'mix';
                    } else {
                        v = 'notrack';
                    }
                    if (song['tracks'].hasOwnProperty(v)) {
                        for (let vtrk of song['tracks'][v]) {
                            let gdid = vtrk['gdid'];
                            let mods = vtrk['mods'];
                            let anc;
                            if (vtrk.hasOwnProperty('resource_key')) {
                                let rk = vtrk['resource_key'];
                                anc = `<a href='https://drive.google.com/open?id=${gdid}&resourcekey=${rk}'>${songTitle} : ${mods}</a>`;
                            } else {
                                anc = `<a href='https://drive.google.com/open?id=${gdid}'>${songTitle} : ${mods}</a>`;
                            }
                            choices.push(anc);
                        }
                    } else { 
                        // no tracks for this voice - just show the song title
                        choices.push(songTitle);
                    }
                } else {
                    // no tracks for this song - just show the song title
                    choices.push(songTitle);
                }
                picks += `<div class='${ancclass}'>` + choices.join("<br/>\n") + "\n</div>";
            }
        }
        if ((! song.hasOwnProperty("tracks") && ! song.hasOwnProperty("sheet"))) {
            // no tracks or sheet - just display song title
            picks = songTitle + "\n";
        }

        let cl = qtetSongs.includes(sid) ? "class='song qtet'" : "class='song'";
        cheat += `<tr data-sid='${sid}' ${cl}><td class='${keyclass}'>${key}</td><td>${picks}</td><td>${words}</td></tr>\n`;
    }
    cheat += `</tbody>\n`;

    cheat += `    <tfoot>
    <tr>
        <td colspan="99">
        <fieldset class="partsel">
        <legend>Show voice</legend>
         <input type="radio" id="seltenor" name="part" value="tenor" onclick="setvoice(this)">tenor
         <input type="radio" id="sellead" name="part" value="lead" onclick="setvoice(this)">lead
         <input type="radio" id="selbari" name="part" value="bari" onclick="setvoice(this)">bari
         <input type="radio" id="selbass" name="part" value="bass" onclick="setvoice(this)">bass
         <input type="radio" id="selmix" name="part" value="mix" onclick="setvoice(this)">mix
         <input type="radio" id="selsheet" name="part" value="sheet" onclick="setvoice(this)">sheet
         <input type="radio" id="selnone" name="part" value="none" onclick="setvoice(this)">none
        </fieldset>
        </td>
     </tr>
    </tfoot>
</table>
</body>
</html>
`;

    cheat = cheat.replaceAll('scr\nipt', 'script');
    let yymoda = evndx.substring(2, 8);
    let dlfn = `${venue}_${yymoda}.html`;
    let pom = document.createElement('a');
    pom.style.display = 'none';

    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(cheat));
    pom.setAttribute('download', dlfn);
    document.body.appendChild(pom);
    pom.click();
    document.body.removeChild(pom);
}

function showhelp() {
    let helpwin = window.open("pickerhelp.html");
}

function loads() {
    let mlurl = "https://dmotteler.github.io/musiclib/musiclib.xml";
    let gmlpromise = getMusicLib(mlurl);

    let elurl = "https://dmotteler.github.io/musiclib/events.xml";
    let gelpromise = getEventList(elurl);

    let promises = [gmlpromise, gelpromise];

    Promise.all(promises).then(values => {
        // musiclib and eventlist loads are complete.
        musiclib = values[0];
        eventlist = values[1];
        // get largest (i.e., latest) event index from events.xml
        let latest = Math.max(...Object.keys(eventlist));

        // get the select element
        let sel = document.getElementById("prevsel");

        // sort the eventlist by date, newest first
        let eventsbydate = Object.keys(eventlist).sort((a, b) => a < b ? 1 : a > b ? -1 : 0);

        // add recent events to the event select
        if (nevshow > 0) {
            let opt = document.createElement("option");
            opt.textContent = "";
            opt.dataset.dtndx = "";
            sel.append(opt);

            opt = document.createElement("option");
            opt.textContent = "select new list";
            opt.dataset.dtndx = "";
            sel.append(opt);

            let nadd = 0;
            for (let ndx of eventsbydate) {
                let ev = eventlist[ndx];
                if (! ev.where.includes("TTS")) {
                    opt = document.createElement("option");
                    opt.textContent = `${ev['where']} - ${ev['when']}`;
                    opt.dataset.dtndx = ndx;
                    sel.append(opt);
                    nadd += 1;
                    if (nadd >= nevshow) {
                        break;
                    }
                }
            }
        }

        // build list of all categories in the library,
        // and a songlib dict, indexed by song name,
        // with values being a list of sids for the name
        allcats = [];
        for (let sid in musiclib) {
            let nam = musiclib[sid]['name'];
            if (musiclib[sid].hasOwnProperty('notes')) {
                nam = `${nam} (${musiclib[sid]['notes']})`;
            }
            if (!songlib.hasOwnProperty(nam)) {
                songlib[nam] = [];
            }
            songlib[nam].push(sid);

            if (musiclib[sid].hasOwnProperty('category')) {
                for (let cat of musiclib[sid]['category']) {
                    if (! allcats.includes(cat)) {
                        allcats.push(cat);
                    }
                }
            }
        }
    });
}

function useprev(el) {
    // an event has been selected. el is the select element

    let opt = el.options[el.selectedIndex];
    let dtndx = opt.dataset.dtndx;

    let gig = dtndx != "" ? eventlist[dtndx] : null;

    if (gig) {
        songlist = gig.songlist;
        if (gig.hasOwnProperty("qtetSongs")) {
            qtetSongs = gig.qtetSongs;
        }
    } else {
        songlist = [];
        qtetSongs = [];
    }

    evcats = [];
    for (let sid of songlist) {
        if (musiclib[sid].hasOwnProperty('category')) {
            for (let cat of musiclib[sid]['category']) {
                if (! evcats.includes(cat)) {
                    evcats.push(cat);
                }
                if (! psCatSelected[cat]) {
                    psCatSelected[cat] = true;
                    for (let catel of document.querySelectorAll("input[name='cats']")) {
                        // category name follows the checkbox, and has unwanted
                        // whitespace after it.
                        let tcat = catel.value;
                        if (tcat == cat) {
                            catel.checked = true;
                        }
                    }
                }
            }
        }
    }
    makelist();
}

function selvenue(el) {
    // a venue has been selected. el is the selected input element
    // set the datepicker to default based on venue.

    venue = el.value;
    console.log(`${venue} selected...`);

    let datel = document.getElementById("eventdate");
    if (datel.value == "") {
        // unless the user has entered the date and time for the event,
        // init date picker to next Tuesday (today if it is Tuesday)
        // if venue is Rehearsal, otherwise Thursday.

        let d = new Date();
        let starth = "18", startm = "00";
        if (venue.includes("ehearsal")) {
            d.setDate(d.getDate() + (7 - d.getDay() + 2) % 7);
        } else {
            d.setDate(d.getDate() + (7 - d.getDay() + 4) % 7);
            startm = "15";
        }

        let day = d.getDate();
        let mo = d.getMonth() + 1;

        // make zero-left-padded strings of day and mo
        let dstr = day.toString().padStart(2, 0);
        let mstr = mo.toString().padStart(2, 0);

        datel.value = `${d.getFullYear()}-${mstr}-${dstr}T${starth}:${startm}`;
    }
    timechg(datel);
}
function timechg(el) {
    // date element lost focus, or venue change
    dat = new Date(el.value);
    // evdate goes in the title
    evdate = formatDate(dat, "%B %d, %Y %I:%M%P");

    // evndx is the index for the eventlist
    evndx = formatDate(dat, "%Y%m%d%H%M");

    let title = `${venue} - ${evdate}`;
    document.title = title;
    document.querySelector("th.tabtitle").innerText = title;
}
function init() {
    // start the load of the xmls.
    loads();
    let catsels = document.querySelectorAll("[type='checkbox']");
    document.querySelector("#prevsel").addEventListener('change', ev => useprev(ev.target));
    // double-click on venue select to clear it so list reappears
    document.querySelector("#venueel").addEventListener('dblclick', ev => { ev.target.value = ""; venue = ""; });
}
var selsid; // song id from selected "from"  row, or null
function fromrow(ev) {
    // mousedown - assume it's start of drag op, inhibit text select
    document.querySelector('#cheat').style.userSelect = "none";

    // un-select any selected row
    let tr = document.querySelector(".selrow");
    if (tr) {
        tr.classList.remove("selrow");
    }
    // select this one
    tr = ev.target.closest('tr');
    // don't add class to tr if we're not in one...
    if (tr) {
        tr.classList.add('selrow');
        // all we really care about later is the song id (sid):
        selsid = tr.dataset.sid;
        console.log(`selsid ${selsid}`);
    }
}
function torow(ev) {
    if (!selsid) {
        return;
    }
    let fromtr = document.querySelector(".selrow");
    if (! fromtr) {
        return;
    }
    let totr = ev.target.closest('tr');
    if (fromtr === totr) {
        fromtr.classList.remove("selrow");
        return;
    }
        
    // if we drag off the side of the table, it means delete.
    let nam = musiclib[selsid].name;
    let fromnum = songlist.indexOf(selsid);
    if (! totr) {
        console.log(`remove row ${fromnum} sid ${selsid} ${nam}`);
        songlist.splice(fromnum,1);
    } else {
        let tonum;
        if (totr.classList.contains("tabletitle")) {
            tonum = -1;
            console.log(`moving ${fromnum} sid ${selsid} ${nam} to top`);
        } else {
            let tosid = totr.dataset.sid;
            let tonam = musiclib[tosid].name;
            tonum = songlist.indexOf(tosid);
            console.log(`moving ${fromnum} sid ${selsid} ${nam} after ${tonum} sid ${tosid} ${tonam} `);
        }
        if (tonum < fromnum) {
            tonum += 1;
        }
        songlist.splice(tonum, 0, songlist.splice(fromnum, 1)[0]);
    }

    // mouseup - assume it's end of drag op, restore text select
    // document.querySelector('#cheat').style.userSelect = "auto";
    makelist();
}
function makelist() {
    // create the html for the songlist display. 
    // each row has key, song title, starting words
    // for all songs from the songlist.
    // the song title td has a div for each voice, with class "hidden" 
    // for all except the current voice being displayed.

    let title = `${venue} - ${evdate}`;
    document.title = title;
    let th = document.querySelector("th.tabtitle");
    th.innerText = title;

    let html = `<tbody id='cheat'>\n`;

    console.log(`in makelist, songlist ${songlist}`);
    for (let sid of songlist) {
        let song = musiclib[sid];
        let songTitle = song['name']; // songTitle becomes name (notes) [location]
        if (song.hasOwnProperty("aliasfor")) {
            let msid = song["aliasfor"];
            song = musiclib[msid];
        }
        let key = song['key'];
        let keyclass = "key";
        if (song.hasOwnProperty('pitch')) {
            let pit = song['pitch'];
            if (pit != "") {
                key = 'blow ' + pit;
                keyclass = "pitch";
            }
        }
        let words = song['words'];
        if (song.hasOwnProperty("notes")) {
            songTitle += ` (${song['notes']})`;
        }
        if (song.hasOwnProperty("location")) {
            songTitle += ` [${song['location']}]`;
        }

        let cl = qtetSongs.includes(sid) ? "class='song qtet'" : "class='song'";
        html += `<tr data-sid='${sid}' ${cl}><td class='${keyclass}'>${key}</td><td>${songTitle}</td><td>${words}</td></tr>\n`;
    }
    html += `</tbody>\n`;
    document.querySelector("#cheat").outerHTML=html;
    document.querySelector(".tabletitle").classList.remove("hidden");

    // note - mousedown only in cheat table, mouseup anywhere
    document.querySelector("#cheat").addEventListener('mousedown', ev => fromrow(ev));
    document.body.addEventListener("mouseup", ev => torow(ev));

    document.querySelector("#cheat").addEventListener('dblclick', ev => togqtet(ev) );
}
function togqtet(ev) {
    let tr = ev.target.closest('tr');
    let songsid = tr.dataset.sid;
    let turnoff = tr.classList.contains("qtet");
    let songnum = qtetSongs.indexOf(songsid);
    let isqtet = songnum > -1;
    let tostate = turnoff ? "off" : "on";
    if (isqtet) {
        if (turnoff) {
            tr.classList.remove("qtet");
            qtetSongs.splice(songnum, 1);
            console.log(`removed ${songnum}, qtetSongs now ${qtetSongs}`);
        } else {
            alert(`sid ${songsid} in qtetSongs but turnoff false in togqtet!`);
        }
    } else if (!turnoff) {
        tr.classList.add("qtet");
        qtetSongs.push(songsid);
    } else {
        alert(`sid ${songsid} not in qtetSongs but turnoff true in togqtet!`);
    }
    let nam = musiclib[songsid].name;
    console.log(`qtet toggled to ${tostate} for ${nam}`);
}
</script>
</head>
<body onload="init()">
<table border="1" id="tabid">
<tr id="venue_date_row"><th colspan='3'>
<label>Songs for:
<input id="venueel" list="venlist" class="select-css" name="venue"
    placeholder="- venue -" onChange="selvenue(this)"/>
</label>
<datalist id="venlist">
<option value="" disabled selected hidden>select Venue</option>
<option>Rehearsal</option>
<option>Chehalis West</option>
<option>Colonial</option>
<option>Sharon Care</option>
<option>South Creek</option>
<option>Vintage</option>
<option>Village Concepts</option>
</datalist>
<label for="eventdate">on</label>
<input type="datetime-local" class="select-css" value="" id="eventdate" step="900" onblur="timechg(this)">
</th></tr>
<tr id="use_row"><th colspan='3'>
<label>Use: 
<select id="prevsel" class="select-css"></select>
</label>
</th></tr>
<tr id="cat_row">
<td class="svi"> <img src="download.svg" onclick="dodl()"/> </td>
<td class="svi"> <img src="help.svg" onclick="showhelp()"/> </td>
<td id='catboxes'>
 <input type='checkbox' name='cats' checked="1" value="Current">Current</input>
 <input type='checkbox' name='cats' checked="1" value="PoleCat">PoleCat</input>
 <input type='checkbox' name='cats' value="Show">Show</input>
 <input type='checkbox' name='cats' value="Christmas">Christmas</input>
 <input type='checkbox' name='cats' checked="1" value="Quartet">Quartet</input>
 <input type='checkbox' name='cats' value="Old">Old</input>
</td>
 <td class="svi"><img src="addsong.svg" class="as" onclick="adds()"/></td>
</tr>
</table>
<br/>
<br/>
<table>
<thead><tr class='tabletitle hidden'><th class='tabtitle' colspan='3'></th></tr></thead>
<tbody id="cheat"> </tbody>
</table>
<div id='ssel'></div>
</body>
</html>
