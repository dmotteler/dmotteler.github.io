<!DOCTYPE html>
<!--

    $Id: ch.html,v 1.1 2022/07/01 18:49:05 dfm Exp dfm $
    $Log: ch.html,v $
    Revision 1.1  2022/07/01 18:49:05  dfm
    Initial revision


    display cheat sheet based on song list from ps.html

-->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title id="doctitle"></title>
<style>
#wrapper { max-width: 800px; }
#main_table, #footer { width: 100%; }
#footer { text-align: center; }
.key, .pitch { text-align: center; }
td select { float: left; margin: 0 auto; width: 100%; }
td { padding: 6px; }
.tabletitle { background-color: lightgreen; text-align: center; font-size: 24px; border-bottom: solid 5px; }
.butts { background: lightgreen; }
.voices { background: lightgreen; }
.hidden { display: none; }
.qtet { background-color: blue !important; color: white !important; }
.qtet a { background-color: blue !important; color: white !important; }
tr:nth-child(even) { background: #CCC }
tr:nth-child(odd) { background: #FFF }
table { border-collapse: collapse; font-family: Arial; font-size: 18px; font-weight: bold; border-width: 5px; }
@media print {
  @page { size: letter portrait; margin: .5in; }
  body { max-width: 5.5in; }
  table { font-size: 12px; }
  td { padding: 4px; }
  .tabletitle { font-size: 18px; }
}
</style>
<script src="getMusicLib.js"></script>
<script>
var voices = ['bass', 'bari', 'lead', 'tenor', 'mix', 'none'];
function clickVoice() {
    let vsels = document.querySelectorAll("[name='part']");
    for (let vsel of vsels) {
        vsel.addEventListener('click', ev => setvoice(ev.target));
    }
    let defaultVoice = localStorage.getItem("defaultVoice");
    if (! defaultVoice) { defaultVoice = "mix"; }
    let buttonId = "#sel" + defaultVoice;
    let butt = document.querySelector(buttonId);
    butt.click();
}
function setvoice(el) {
    let voice = el.value;
    let clr = "." + voice;
    // show the class we were called with (i.e., remove "hidden")
    document.querySelectorAll(clr).forEach(node => { node.classList.remove("hidden") });
    let others = new Set(voices);
    others.delete(voice);
    // don't show the rest of the classes
    for (let v of others) {
        let cla = "." + v;
        document.querySelectorAll(cla).forEach(node => { node.classList.add("hidden") });
    }
    if (voice != "none") {
        localStorage.setItem("defaultVoice", voice);
    }
}
// BEGIN CLIP
// songlib is indexed by song name, values are
//   lists of song ids with that name
var songlib = [];
var chevt;
var evdate;
var elcancel; // set true/false by el.html on exit
var venue;
var songlist;
var qtetSongs;

function init() {
    let mlurl = "musiclib.xml";
    let gmlpromise = getMusicLib(mlurl);

    let promises = [gmlpromise];

    Promise.all(promises).then(values => {
        // all promises complete. values is list of values returned 
        // by the promises, in the same order.
        musiclib = values[0];

        chevt = opener.newevent;
        venue = chevt['where'];
        evdate = chevt['when'];

        songlist = chevt['songlist'];

        qtetSongs = [];
        if (chevt.hasOwnProperty("qtetSongs")) {
            let qs = chevt['qtetSongs'];
            if (qs[0] == '[') {
                // got a string - strip off [], split into list
                console.log(`split quartetSongs ${qs}`);
                qs = qs.substring(1, qs.length-1).split(", ");
            }
            qtetSongs = chevt['qtetSongs'];
        }

        makelist();
        clickVoice();

        const maintab = document.querySelector("#main_table");
        maintab.addEventListener('contextmenu', ev => togqtet(ev));
    });
}
function makelist() {
    let title = `${venue} - ${evdate}`;
    document.title = title;

    let html = `<tr><td colspan='3' class='tabletitle'>${title}</td></tr>`;
    console.log(`in makelist, songlist ${songlist}`);
    for (let sid of songlist) {
        let song = musiclib[sid];
        let songTitle = song['name']; // songTitle becomes name (notes) [location]
        if (song.hasOwnProperty("aliasfor")) {
            let msid = song["aliasfor"];
            song = musiclib[msid];
        }
        let key = song['key'];
        let keyclass = "key";
        if (song.hasOwnProperty('pitch')) {
            let pit = song['pitch'];
            if (pit != "") {
                key = 'blow ' + pit;
                keyclass = "pitch";
            }
        }
        let words = song['words'];
        if (song.hasOwnProperty("notes")) {
            songTitle += ` (${song['notes']})`;
        }
        if (song.hasOwnProperty("location")) {
            songTitle += ` [${song['location']}]`;
        }
        let picks = "";
        if (song.hasOwnProperty("tracks")) {
            for (let voice of voices) {
                let choices = [];
                let ancclass = voice;
                if (voice != "mix") {
                    ancclass += " hidden";
                }
                if (song['tracks'].hasOwnProperty(voice)) {
                    for (let vtrk of song['tracks'][voice]) {
                        let gdid = vtrk['gdid'];
                        let mods = vtrk['mods'];
                        choices.push(`<a href='https://drive.google.com/open?id=${gdid}'>${songTitle} : ${mods}</a>`);
                    }
                } else { 
                    // no tracks for this voice
                    choices.push(songTitle);
                }
                picks += `<div class='${ancclass}'>` + choices.join("<br/>\n") + "\n</div>";
            }
        } else {
            picks = songTitle + "\n";
        }

        let cl = qtetSongs.includes(sid) ? "class='song qtet'" : "class='song'";
        html += `<tr ${cl}><td class='${keyclass}'>${key}</td><td>${picks}</td><td>${words}</td></tr>\n`;
    }
    document.querySelector("#main_table").innerHTML=html;
}
function down() {
    document.querySelector(".butts").parentNode.deleteCell(0);

    // get the html
    let h = document.documentElement.outerHTML;

    // remove the functions not needed in downloaded file
    let clipstart = h.indexOf("// BEGIN CLIP");
    let clipend = h.lastIndexOf("// END CLIP") + "// END CLIP".length + 1;
    let dlhtml = h.substr(0, clipstart) + h.substr(clipend).replace("init", "clickVoice");
    let yymoda = opener.evndx.substring(2, 8);
    let dlfn = `${venue}_${yymoda}.html`;
    let pom = document.createElement('a');
    pom.style.display = 'none';
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(dlhtml));
    pom.setAttribute('download', dlfn);
    document.body.appendChild(pom);
    pom.click();
    document.body.removeChild(pom);
}
function togqtet(ev) {
    // right-click will do the context menu when we leave
    // if we don't prevent it.
    ev.preventDefault();

    // find the song row that was clicked
    let tr = ev.target.closest("tr");
    // don't try to update non-song rows...
    if (tr.classList.contains("song")) {
        // get the row index, and the associated song name 
        // (note: songlist does not change in this page)
        let n = tr.rowIndex - 1;
        let sid = songlist[n];
        if (tr.classList.contains("qtet")) {
            // qtet song selected - remove it
            let n2 = qtetSongs.indexOf(sid);
            if (n2 > -1) {
                qtetSongs.splice(n2, 1);
            }
            tr.classList.remove("qtet");
            console.log(`removed qtet song ${song}`);
        } else {
            // non-qtet song selected - add it
            qtetSongs.push(sid);
            tr.classList.add("qtet");
            console.log(`added qtet song ${sid}`);
        }
    }
}
function calledit() {
    let elwin = window.open("el.html", "_blank");
    elwin.onblur = function() {
        if (elwin.closed) {
            if (elcancel) {
                console.log(`editlist cancelled. songlist ${chevt['songlist']}`);
            }
            // el.html probably changed songlist and/or qtetSongs
            // and always sets cancelled true or false

            songlist = chevt['songlist'];

            qtetSongs = [];
            if (chevt.hasOwnProperty("qtetSongs")) {
                let qs = chevt['qtetSongs'];
                if (qs[0] == '[') {
                    // got a string - strip off [], split into list
                    console.log(`split quartetSongs in calledit ${qs}`);
                    qs = qs.substring(1, qs.length-1).split(", ");
                }
                qtetSongs = chevt['qtetSongs'];
            }
            console.log(`back from el.html with songlist ${songlist}, qtetSongs ${qtetSongs}`);

            makelist();
        } else {
            console.log("elwin unload in parent?");
        }
    }
}
// END CLIP
</script>
</head>
<body onload='init()'>
<table id="wrapper">
    <tr><td>
        <table id="main_table" border='1'>
            <tr id="putithere"></tr>
        </table>
    </td></tr>
    <tr><td>
    <table id="footer">
        <tr><td class='butts'>
             <input type="button" value="Download" onclick="down()"></input><br/>
             <input type="button" value="Edit list" onclick="calledit()"></input></td>
        <td colspan="99">
        <fieldset class="voices">
        <legend>Show voice</legend>
         <input type="radio" id="seltenor" name="part" value="tenor">tenor</input>
         <input type="radio" id="sellead" name="part" value="lead">lead</input>
         <input type="radio" id="selbari" name="part" value="bari">bari</input>
         <input type="radio" id="selbass" name="part" value="bass">bass</input>
         <input type="radio" id="selmix" name="part" value="mix">mix</input>
         <input type="radio" id="selnone" name="part" value="none">none</input>
        </fieldset>
        </td>
         </tr>
        </table>
    </tr></td>
</table>
</body>
</html>
